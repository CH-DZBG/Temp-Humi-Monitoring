<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHT22 æ¸©æ¹¿åº¦ç›‘æ§ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-header i {
            font-size: 1.5em;
            margin-right: 10px;
        }
        
        .card-header h3 {
            color: #333;
            font-size: 1.3em;
        }
        
        .data-display {
            text-align: center;
        }
        
        .data-value {
            font-size: 3.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .temperature {
            color: #e74c3c;
        }
        
        .humidity {
            color: #3498db;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }
        
        .status-offline {
            background: #e74c3c;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        
        .devices-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .device-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .device-card:hover {
            background: #f0f2f5;
            transform: translateX(5px);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .device-name {
            font-weight: bold;
            color: #333;
        }
        
        .device-status {
            font-size: 0.9em;
            color: #666;
        }
        
        .device-data {
            display: flex;
            justify-content: space-between;
        }
        
        .temp-badge, .hum-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .temp-badge {
            background: #ffebee;
            color: #e74c3c;
        }
        
        .hum-badge {
            background: #e3f2fd;
            color: #3498db;
        }
        
        .config-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .data-table tr:hover {
            background: #f5f5f5;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.success {
            background: #2ecc71;
        }
        
        .notification.error {
            background: #e74c3c;
        }
        
        .notification.info {
            background: #3498db;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .no-data i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .last-update {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin-top: 30px;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 15px;
            }
            
            .data-value {
                font-size: 2.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¡ï¸ DHT22 æ¸©æ¹¿åº¦ç›‘æ§ç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æ§å¤šä¸ªESP8266è®¾å¤‡çš„æ¸©æ¹¿åº¦æ•°æ®</p>
        </div>
        
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="total-devices">0</div>
                <div class="stat-label">è®¾å¤‡æ€»æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="online-devices">0</div>
                <div class="stat-label">åœ¨çº¿è®¾å¤‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-temperature">--Â°C</div>
                <div class="stat-label">å¹³å‡æ¸©åº¦</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-humidity">--%</div>
                <div class="stat-label">å¹³å‡æ¹¿åº¦</div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <i>ğŸŒ¡ï¸</i>
                    <h3>å½“å‰æ¸©åº¦</h3>
                </div>
                <div class="data-display">
                    <div class="data-value temperature" id="current-temp">--Â°C</div>
                    <p id="temp-device">--</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i>ğŸ’§</i>
                    <h3>å½“å‰æ¹¿åº¦</h3>
                </div>
                <div class="data-display">
                    <div class="data-value humidity" id="current-hum">--%</div>
                    <p id="hum-device">--</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i>ğŸ“ˆ</i>
                    <h3>æ•°æ®ç»Ÿè®¡</h3>
                </div>
                <div class="data-display">
                    <div style="margin: 20px 0; text-align: left;">
                        <div>æœ€é«˜æ¸©åº¦: <span id="max-temp" class="temperature">--Â°C</span></div>
                        <div>æœ€ä½æ¸©åº¦: <span id="min-temp" class="temperature">--Â°C</span></div>
                        <div>å¹³å‡æ¸©åº¦: <span id="avg-temp-display" class="temperature">--Â°C</span></div>
                        <div>å¹³å‡æ¹¿åº¦: <span id="avg-hum-display" class="humidity">--%</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="devices-panel">
            <div class="card-header">
                <i>ğŸ“±</i>
                <h3>è®¾å¤‡ç›‘æ§</h3>
                <div class="device-status">
                    <span class="status-indicator" id="mqtt-status-indicator"></span>
                    MQTTçŠ¶æ€: <span id="mqtt-status-text">æœªè¿æ¥</span>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="devices">è®¾å¤‡åˆ—è¡¨</div>
                <div class="tab" data-tab="chart">æ•°æ®å›¾è¡¨</div>
                <div class="tab" data-tab="history">å†å²æ•°æ®</div>
            </div>
            
            <div class="tab-content active" id="devices-tab">
                <div id="devices-container" class="devices-grid">
                    <div class="no-data">
                        <div>ğŸ“¡</div>
                        <h3>æš‚æ— è®¾å¤‡æ•°æ®</h3>
                        <p>è¯·ç¡®ä¿MQTTè¿æ¥æ­£å¸¸ï¼Œå¹¶ä¸”æœ‰è®¾å¤‡åœ¨å‘å¸ƒæ•°æ®</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="chart-tab">
                <div class="chart-container">
                    <canvas id="dataChart"></canvas>
                </div>
            </div>
            
            <div class="tab-content" id="history-tab">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>è®¾å¤‡</th>
                            <th>æ¸©åº¦</th>
                            <th>æ¹¿åº¦</th>
                            <th>ä¿¡å·å¼ºåº¦</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                                æš‚æ— å†å²æ•°æ®
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="config-panel">
            <div class="card-header">
                <i>âš™ï¸</i>
                <h3>MQTTé…ç½®</h3>
            </div>
            
            <div class="form-group">
                <label>MQTTæœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="mqtt-broker" class="form-control" value="wss://broker.hivemq.com:8884/mqtt" placeholder="wss://broker.hivemq.com:8884/mqtt">
                <small style="color: #666; margin-top: 5px; display: block;">æ¨èä½¿ç”¨HiveMQæœåŠ¡å™¨ï¼Œè¿æ¥æ›´ç¨³å®š</small>
            </div>
            
            <div class="form-group">
                <label>è®¢é˜…ä¸»é¢˜:</label>
                <input type="text" id="mqtt-topic" class="form-control" value="dht22/sensor_data" placeholder="dht22/sensor_data">
                <small style="color: #666; margin-top: 5px; display: block;">ESP8266å‘å¸ƒæ•°æ®çš„ä¸»é¢˜</small>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="connectMQTT()" class="btn" id="connect-btn">è¿æ¥MQTTæœåŠ¡å™¨</button>
                <button onclick="clearData()" class="btn btn-danger">æ¸…é™¤æ•°æ®</button>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin-bottom: 10px;">ğŸ“¡ è¿æ¥çŠ¶æ€</h4>
                <div>MQTTæœåŠ¡å™¨: <span id="current-broker">æœªè¿æ¥</span></div>
                <div>è®¢é˜…ä¸»é¢˜: <span id="current-topic">æœªè®¾ç½®</span></div>
                <div>æœ€åæ¶ˆæ¯: <span id="last-message-time">--</span></div>
                <div>æ¥æ”¶æ¶ˆæ¯æ•°: <span id="message-count">0</span></div>
            </div>
        </div>
        
        <div class="last-update">
            <p>ç›‘æ§ç³»ç»Ÿ v1.1 | æ•°æ®è‡ªåŠ¨æ›´æ–° | æ”¯æŒå¤šè®¾å¤‡ç›‘æ§ | æœ€åæ›´æ–°: <span id="last-update-time">--:--:--</span></p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let mqttClient = null;
        let dataChart = null;
        let devices = new Map();
        let selectedDevice = null;
        let messageCount = 0;
        
        // å›¾è¡¨æ•°æ®
        let chartData = {
            labels: [],
            datasets: [{
                label: 'æ¸©åº¦ (Â°C)',
                data: [],
                borderColor: 'rgb(231, 76, 60)',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }, {
                label: 'æ¹¿åº¦ (%)',
                data: [],
                borderColor: 'rgb(52, 152, 219)',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        };
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<div>${message}</div>`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            
            if (dataChart) {
                dataChart.destroy();
            }
            
            dataChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { font: { size: 14 } }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { size: 12 } }
                        },
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { size: 12 } }
                        }
                    }
                }
            });
        }
        
        // è¿æ¥MQTTæœåŠ¡å™¨
        function connectMQTT() {
            const broker = document.getElementById('mqtt-broker').value.trim();
            const topic = document.getElementById('mqtt-topic').value.trim();
            
            if (!broker || !topic) {
                showNotification('è¯·å¡«å†™MQTTæœåŠ¡å™¨åœ°å€å’Œè®¢é˜…ä¸»é¢˜', 'error');
                return;
            }
            
            // å¦‚æœå·²è¿æ¥ï¼Œå…ˆæ–­å¼€
            if (mqttClient && mqttClient.connected) {
                mqttClient.end();
            }
            
            // æ›´æ–°UIçŠ¶æ€
            document.getElementById('current-broker').textContent = broker;
            document.getElementById('current-topic').textContent = topic;
            document.getElementById('connect-btn').textContent = 'è¿æ¥ä¸­...';
            document.getElementById('connect-btn').disabled = true;
            
            // MQTTè¿æ¥é€‰é¡¹
            const options = {
                clean: true,
                connectTimeout: 4000,
                clientId: 'web_client_' + Math.random().toString(16).substr(2, 8),
                keepalive: 60
            };
            
            try {
                // è¿æ¥MQTT
                mqttClient = mqtt.connect(broker, options);
                
                mqttClient.on('connect', () => {
                    console.log('MQTTè¿æ¥æˆåŠŸ');
                    showNotification('MQTTè¿æ¥æˆåŠŸ', 'success');
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    document.getElementById('mqtt-status-indicator').className = 'status-indicator status-online';
                    document.getElementById('mqtt-status-text').textContent = 'å·²è¿æ¥';
                    document.getElementById('connect-btn').textContent = 'å·²è¿æ¥';
                    
                    // è®¢é˜…ä¸»é¢˜
                    mqttClient.subscribe(topic, (err) => {
                        if (err) {
                            console.error('è®¢é˜…å¤±è´¥:', err);
                            showNotification('è®¢é˜…å¤±è´¥: ' + err.message, 'error');
                        } else {
                            console.log(`å·²è®¢é˜…ä¸»é¢˜: ${topic}`);
                        }
                    });
                });
                
                mqttClient.on('message', (topic, message) => {
                    try {
                        const data = JSON.parse(message.toString());
                        processMessage(topic, data);
                    } catch (error) {
                        console.error('è§£ææ¶ˆæ¯å¤±è´¥:', error, 'åŸå§‹æ¶ˆæ¯:', message.toString());
                    }
                });
                
                mqttClient.on('error', (error) => {
                    console.error('MQTTé”™è¯¯:', error);
                    showNotification('è¿æ¥é”™è¯¯: ' + error.message, 'error');
                    
                    document.getElementById('mqtt-status-indicator').className = 'status-indicator status-offline';
                    document.getElementById('mqtt-status-text').textContent = 'è¿æ¥å¤±è´¥';
                    document.getElementById('connect-btn').textContent = 'è¿æ¥MQTTæœåŠ¡å™¨';
                    document.getElementById('connect-btn').disabled = false;
                });
                
                mqttClient.on('close', () => {
                    console.log('MQTTè¿æ¥æ–­å¼€');
                    showNotification('è¿æ¥å·²æ–­å¼€', 'info');
                    
                    document.getElementById('mqtt-status-indicator').className = 'status-indicator status-offline';
                    document.getElementById('mqtt-status-text').textContent = 'å·²æ–­å¼€';
                    document.getElementById('connect-btn').textContent = 'è¿æ¥MQTTæœåŠ¡å™¨';
                    document.getElementById('connect-btn').disabled = false;
                });
                
            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                showNotification('è¿æ¥å¤±è´¥: ' + error.message, 'error');
                
                document.getElementById('connect-btn').textContent = 'è¿æ¥MQTTæœåŠ¡å™¨';
                document.getElementById('connect-btn').disabled = false;
            }
        }
        
        // å¤„ç†MQTTæ¶ˆæ¯
        function processMessage(topic, data) {
            messageCount++;
            document.getElementById('message-count').textContent = messageCount;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            // æ›´æ–°æœ€åæ¶ˆæ¯æ—¶é—´
            document.getElementById('last-message-time').textContent = timeStr;
            document.getElementById('last-update-time').textContent = timeStr;
            
            // æå–è®¾å¤‡ID - å¤„ç†å¤šç§å¯èƒ½çš„å­—æ®µå
            let deviceId = data.device_id || data.device || data.deviceId || 'æœªçŸ¥è®¾å¤‡';
            
            // å¦‚æœè®¾å¤‡IDæ˜¯"æœªçŸ¥è®¾å¤‡"ï¼Œå°è¯•ä»ä¸»é¢˜ä¸­æå–
            if (deviceId === 'æœªçŸ¥è®¾å¤‡' && topic.includes('/')) {
                const parts = topic.split('/');
                deviceId = parts[parts.length - 1] || 'æœªçŸ¥è®¾å¤‡';
            }
            
            // å­˜å‚¨è®¾å¤‡æ•°æ®
            if (!devices.has(deviceId)) {
                devices.set(deviceId, {
                    id: deviceId,
                    data: [],
                    lastUpdate: now.getTime(),
                    online: true
                });
                
                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªè®¾å¤‡ï¼Œè‡ªåŠ¨é€‰ä¸­
                if (!selectedDevice) {
                    selectedDevice = deviceId;
                }
            }
            
            const device = devices.get(deviceId);
            device.lastUpdate = now.getTime();
            device.online = true;
            
            // æå–æ¸©åº¦æ¹¿åº¦æ•°æ® - å¤„ç†å¤šç§å¯èƒ½çš„å­—æ®µå
            const temperature = data.temperature !== undefined ? data.temperature : 
                              (data.temp !== undefined ? data.temp : null);
            const humidity = data.humidity !== undefined ? data.humidity : 
                           (data.hum !== undefined ? data.hum : null);
            const rssi = data.rssi !== undefined ? data.rssi : null;
            
            // åˆ›å»ºè®°å½•
            const record = {
                time: now,
                timestamp: data.timestamp || now.getTime(),
                temperature: temperature,
                humidity: humidity,
                rssi: rssi,
                topic: topic
            };
            
            device.data.push(record);
            
            // ä¿æŒæœ€è¿‘50æ¡è®°å½•
            if (device.data.length > 50) {
                device.data.shift();
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateMainDisplay(deviceId, record);
            updateDevicesList();
            updateStatistics();
            updateHistoryTable(deviceId, record);
            
            // å¦‚æœè¿™æ˜¯é€‰ä¸­çš„è®¾å¤‡ï¼Œæ›´æ–°å›¾è¡¨
            if (deviceId === selectedDevice) {
                updateChart(device);
            }
        }
        
        // æ›´æ–°ä¸»æ˜¾ç¤º
        function updateMainDisplay(deviceId, record) {
            if (record.temperature !== null) {
                document.getElementById('current-temp').textContent = 
                    record.temperature.toFixed(1) + 'Â°C';
                document.getElementById('temp-device').textContent = deviceId;
            }
            
            if (record.humidity !== null) {
                document.getElementById('current-hum').textContent = 
                    record.humidity.toFixed(1) + '%';
                document.getElementById('hum-device').textContent = deviceId;
            }
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateChart(device) {
            if (!device || device.data.length === 0) return;
            
            // æ¸…ç©ºå›¾è¡¨æ•°æ®
            chartData.labels = [];
            chartData.datasets[0].data = [];
            chartData.datasets[1].data = [];
            
            // æ·»åŠ æœ€è¿‘20ä¸ªæ•°æ®ç‚¹
            const recentData = device.data.slice(-20);
            
            recentData.forEach(record => {
                const timeLabel = record.time.getHours().toString().padStart(2, '0') + ':' + 
                                record.time.getMinutes().toString().padStart(2, '0') + ':' + 
                                record.time.getSeconds().toString().padStart(2, '0');
                
                chartData.labels.push(timeLabel);
                chartData.datasets[0].data.push(record.temperature);
                chartData.datasets[1].data.push(record.humidity);
            });
            
            // åˆå§‹åŒ–æˆ–æ›´æ–°å›¾è¡¨
            if (!dataChart) {
                initChart();
            } else {
                dataChart.update('none');
            }
        }
        
        // æ›´æ–°è®¾å¤‡åˆ—è¡¨
        function updateDevicesList() {
            const container = document.getElementById('devices-container');
            
            if (devices.size === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <div>ğŸ“¡</div>
                        <h3>æš‚æ— è®¾å¤‡æ•°æ®</h3>
                        <p>è¯·ç¡®ä¿MQTTè¿æ¥æ­£å¸¸ï¼Œå¹¶ä¸”æœ‰è®¾å¤‡åœ¨å‘å¸ƒæ•°æ®</p>
                    </div>
                `;
                return;
            }
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // æ·»åŠ è®¾å¤‡å¡ç‰‡
            devices.forEach((device, deviceId) => {
                const latestRecord = device.data[device.data.length - 1];
                const timeDiff = (Date.now() - device.lastUpdate) / 1000;
                const isOnline = timeDiff < 60;
                
                const deviceCard = document.createElement('div');
                deviceCard.className = 'device-card';
                deviceCard.style.borderLeftColor = deviceId === selectedDevice ? '#667eea' : '#ddd';
                deviceCard.style.cursor = 'pointer';
                
                deviceCard.onclick = () => {
                    selectedDevice = deviceId;
                    updateDevicesList();
                    
                    if (device.data.length > 0) {
                        updateMainDisplay(deviceId, device.data[device.data.length - 1]);
                        updateChart(device);
                    }
                };
                
                let content = `
                    <div class="device-header">
                        <div class="device-name">${deviceId}</div>
                        <div class="device-status">
                            <span class="status-indicator ${isOnline ? 'status-online' : 'status-offline'}"></span>
                            ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                        </div>
                    </div>
                `;
                
                if (latestRecord) {
                    content += `
                        <div class="device-data">
                            <div>
                                <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">æ¸©åº¦</div>
                                <div class="temp-badge">${latestRecord.temperature !== null ? latestRecord.temperature.toFixed(1) + 'Â°C' : 'N/A'}</div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">æ¹¿åº¦</div>
                                <div class="hum-badge">${latestRecord.humidity !== null ? latestRecord.humidity.toFixed(1) + '%' : 'N/A'}</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.8em; color: #888;">
                            æœ€åæ›´æ–°: ${new Date(device.lastUpdate).toLocaleTimeString()}
                        </div>
                    `;
                } else {
                    content += `
                        <div style="color: #999; text-align: center; padding: 10px 0;">
                            æš‚æ— æ•°æ®
                        </div>
                    `;
                }
                
                deviceCard.innerHTML = content;
                container.appendChild(deviceCard);
            });
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStatistics() {
            let totalTemp = 0;
            let totalHum = 0;
            let tempCount = 0;
            let humCount = 0;
            let maxTemp = -Infinity;
            let minTemp = Infinity;
            let onlineCount = 0;
            
            const now = Date.now();
            
            devices.forEach(device => {
                if (now - device.lastUpdate < 60000) {
                    onlineCount++;
                }
                
                if (device.data.length > 0) {
                    const latest = device.data[device.data.length - 1];
                    
                    if (latest.temperature !== null) {
                        totalTemp += latest.temperature;
                        tempCount++;
                        maxTemp = Math.max(maxTemp, latest.temperature);
                        minTemp = Math.min(minTemp, latest.temperature);
                    }
                    
                    if (latest.humidity !== null) {
                        totalHum += latest.humidity;
                        humCount++;
                    }
                }
            });
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('total-devices').textContent = devices.size;
            document.getElementById('online-devices').textContent = onlineCount;
            
            if (tempCount > 0) {
                const avgTemp = totalTemp / tempCount;
                document.getElementById('avg-temperature').textContent = avgTemp.toFixed(1) + 'Â°C';
                document.getElementById('avg-temp-display').textContent = avgTemp.toFixed(1) + 'Â°C';
                document.getElementById('max-temp').textContent = maxTemp.toFixed(1) + 'Â°C';
                document.getElementById('min-temp').textContent = minTemp.toFixed(1) + 'Â°C';
            }
            
            if (humCount > 0) {
                const avgHum = totalHum / humCount;
                document.getElementById('avg-humidity').textContent = avgHum.toFixed(1) + '%';
                document.getElementById('avg-hum-display').textContent = avgHum.toFixed(1) + '%';
            }
        }
        
        // æ›´æ–°å†å²æ•°æ®è¡¨
        function updateHistoryTable(deviceId, record) {
            const tbody = document.getElementById('history-table-body');
            
            // ç§»é™¤"æš‚æ— æ•°æ®"è¡Œ
            if (tbody.children.length === 1 && tbody.children[0].children.length === 1) {
                tbody.innerHTML = '';
            }
            
            const timeStr = record.time.toLocaleTimeString();
            const tempStr = record.temperature !== null ? record.temperature.toFixed(1) + 'Â°C' : 'N/A';
            const humStr = record.humidity !== null ? record.humidity.toFixed(1) + '%' : 'N/A';
            const rssiStr = record.rssi !== null ? record.rssi + ' dBm' : 'N/A';
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${timeStr}</td>
                <td>${deviceId}</td>
                <td>${tempStr}</td>
                <td>${humStr}</td>
                <td>${rssiStr}</td>
            `;
            
            tbody.insertBefore(newRow, tbody.firstChild);
            
            // é™åˆ¶è¡Œæ•°
            if (tbody.children.length > 50) {
                tbody.removeChild(tbody.lastChild);
            }
        }
        
        // æ¸…é™¤æ•°æ®
        function clearData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                devices.clear();
                selectedDevice = null;
                messageCount = 0;
                
                // é‡ç½®æ˜¾ç¤º
                document.getElementById('current-temp').textContent = '--Â°C';
                document.getElementById('current-hum').textContent = '--%';
                document.getElementById('temp-device').textContent = '--';
                document.getElementById('hum-device').textContent = '--';
                document.getElementById('max-temp').textContent = '--Â°C';
                document.getElementById('min-temp').textContent = '--Â°C';
                document.getElementById('avg-temp-display').textContent = '--Â°C';
                document.getElementById('avg-hum-display').textContent = '--%';
                document.getElementById('total-devices').textContent = '0';
                document.getElementById('online-devices').textContent = '0';
                document.getElementById('avg-temperature').textContent = '--Â°C';
                document.getElementById('avg-humidity').textContent = '--%';
                document.getElementById('message-count').textContent = '0';
                
                // æ¸…ç©ºè¡¨æ ¼
                const tbody = document.getElementById('history-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                            æš‚æ— å†å²æ•°æ®
                        </td>
                    </tr>
                `;
                
                // æ¸…ç©ºè®¾å¤‡åˆ—è¡¨
                const container = document.getElementById('devices-container');
                container.innerHTML = `
                    <div class="no-data">
                        <div>ğŸ“¡</div>
                        <h3>æš‚æ— è®¾å¤‡æ•°æ®</h3>
                        <p>è¯·ç¡®ä¿MQTTè¿æ¥æ­£å¸¸ï¼Œå¹¶ä¸”æœ‰è®¾å¤‡åœ¨å‘å¸ƒæ•°æ®</p>
                    </div>
                `;
                
                // æ¸…ç©ºå›¾è¡¨
                if (dataChart) {
                    chartData.labels = [];
                    chartData.datasets[0].data = [];
                    chartData.datasets[1].data = [];
                    dataChart.update();
                }
                
                showNotification('æ•°æ®å·²æ¸…é™¤', 'info');
            }
        }
        
        // åˆå§‹åŒ–æ ‡ç­¾é¡µ
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tabId + '-tab').classList.add('active');
                    
                    if (tabId === 'chart' && selectedDevice && devices.has(selectedDevice)) {
                        updateChart(devices.get(selectedDevice));
                    }
                });
            });
        }
        
        // å®šæœŸæ£€æŸ¥è®¾å¤‡çŠ¶æ€
        function checkDeviceStatus() {
            const now = Date.now();
            
            devices.forEach(device => {
                device.online = (now - device.lastUpdate) < 60000;
            });
            
            updateDevicesList();
            updateStatistics();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            // åˆå§‹åŒ–æ ‡ç­¾é¡µ
            initTabs();
            
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
            
            // 5ç§’åè‡ªåŠ¨è¿æ¥
            setTimeout(() => {
                connectMQTT();
            }, 5000);
            
            // å®šæœŸæ£€æŸ¥è®¾å¤‡çŠ¶æ€
            setInterval(checkDeviceStatus, 30000);
            
            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            setTimeout(() => {
                showNotification('ç³»ç»Ÿå·²å¯åŠ¨ï¼Œ5ç§’åè‡ªåŠ¨è¿æ¥MQTTæœåŠ¡å™¨...', 'info');
            }, 1000);
        };
    </script>
</body>
</html>



