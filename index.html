<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸©æ¹¿åº¦ç›‘æ§ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-header i {
            font-size: 1.5em;
            margin-right: 10px;
        }
        
        .card-header h3 {
            color: #333;
            font-size: 1.3em;
        }
        
        .data-display {
            text-align: center;
        }
        
        .data-value {
            font-size: 3.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .temperature {
            color: #e74c3c;
        }
        
        .humidity {
            color: #3498db;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }
        
        .status-offline {
            background: #e74c3c;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        
        .devices-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .device-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .device-card:hover {
            background: #f0f2f5;
            transform: translateX(5px);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .device-name {
            font-weight: bold;
            color: #333;
        }
        
        .device-status {
            font-size: 0.9em;
            color: #666;
        }
        
        .device-data {
            display: flex;
            justify-content: space-between;
        }
        
        .temp-badge, .hum-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .temp-badge {
            background: #ffebee;
            color: #e74c3c;
        }
        
        .hum-badge {
            background: #e3f2fd;
            color: #3498db;
        }
        
        .config-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .data-table tr:hover {
            background: #f5f5f5;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .notification.success {
            background: #2ecc71;
        }
        
        .notification.error {
            background: #e74c3c;
        }
        
        .notification.info {
            background: #3498db;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .no-data {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .no-data i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .last-update {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin-top: 30px;
            font-size: 0.9em;
        }
        
        .control-panel {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .control-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .control-btn.active {
            background: #667eea;
            color: white;
        }
        
        .command-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .command-input input {
            flex: 1;
        }
        
        /* è®¾å¤‡çŠ¶æ€é¢æ¿æ ·å¼ */
        .status-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        
        .status-card:hover {
            background: #f0f2f5;
            transform: translateX(5px);
        }
        
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-name {
            font-weight: bold;
            color: #333;
        }
        
        .status-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .status-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.9em;
            color: #666;
        }
        
        /* é€‰ä¸­è®¾å¤‡æ ‡è¯† */
        .device-card.selected {
            border-left: 4px solid #667eea !important;
            background-color: #e8f4fd;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 15px;
            }
            
            .data-value {
                font-size: 2.5em;
            }
            
            .control-panel {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¡ï¸ æ¸©æ¹¿åº¦ç›‘æ§ç³»ç»Ÿ  </h1>
            <p>å®æ—¶ç›‘æ§å¤šä¸ªè®¾å¤‡çš„æ¸©æ¹¿åº¦æ•°æ®</p>
        </div>
        
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="total-devices">0</div>
                <div class="stat-label">è®¾å¤‡æ€»æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="online-devices">0</div>
                <div class="stat-label">åœ¨çº¿è®¾å¤‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-temperature">--Â°C</div>
                <div class="stat-label">å¹³å‡æ¸©åº¦</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-humidity">--%</div>
                <div class="stat-label">å¹³å‡æ¹¿åº¦</div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <i>ğŸŒ¡ï¸</i>
                    <h3>å½“å‰æ¸©åº¦</h3>
                </div>
                <div class="data-display">
                    <div class="data-value temperature" id="current-temp">--Â°C</div>
                    <p id="temp-device">è®¾å¤‡: --</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i>ğŸ’§</i>
                    <h3>å½“å‰æ¹¿åº¦</h3>
                </div>
                <div class="data-display">
                    <div class="data-value humidity" id="current-hum">--%</div>
                    <p id="hum-device">è®¾å¤‡: --</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i>ğŸ“ˆ</i>
                    <h3>æ•°æ®ç»Ÿè®¡</h3>
                </div>
                <div class="data-display">
                    <div style="margin: 20px 0; text-align: left;">
                        <div>æœ€é«˜æ¸©åº¦: <span id="max-temp" class="temperature">--Â°C</span></div>
                        <div>æœ€ä½æ¸©åº¦: <span id="min-temp" class="temperature">--Â°C</span></div>
                        <div>å¹³å‡æ¸©åº¦: <span id="avg-temp-display" class="temperature">--Â°C</span></div>
                        <div>å¹³å‡æ¹¿åº¦: <span id="avg-hum-display" class="humidity">--%</span></div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                            ä¼ æ„Ÿå™¨çŠ¶æ€: <span id="sensor-status">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="devices-panel">
            <div class="card-header">
                <i>ğŸ“±</i>
                <h3>è®¾å¤‡ç›‘æ§</h3>
                <div class="device-status">
                    <span class="status-indicator" id="mqtt-status-indicator"></span>
                    MQTTçŠ¶æ€: <span id="mqtt-status-text">æœªè¿æ¥</span>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="devices">è®¾å¤‡åˆ—è¡¨</div>
                <div class="tab" data-tab="chart">æ•°æ®å›¾è¡¨</div>
                <div class="tab" data-tab="history">å†å²æ•°æ®</div>
                <div class="tab" data-tab="control">è®¾å¤‡æ§åˆ¶</div>
            </div>
            
            <div class="tab-content active" id="devices-tab">
                <div id="devices-container" class="devices-grid">
                    <div class="no-data">
                        <div>ğŸ“¡</div>
                        <h3>æš‚æ— è®¾å¤‡æ•°æ®</h3>
                        <p>è¯·ç¡®ä¿MQTTè¿æ¥æ­£å¸¸ï¼Œå¹¶ä¸”æœ‰è®¾å¤‡åœ¨å‘å¸ƒæ•°æ®</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="chart-tab">
                <div class="chart-container">
                    <canvas id="dataChart"></canvas>
                </div>
            </div>
            
            <div class="tab-content" id="history-tab">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>è®¾å¤‡</th>
                            <th>æ¸©åº¦</th>
                            <th>æ¹¿åº¦</th>
                            <th>ä¼ æ„Ÿå™¨çŠ¶æ€</th>
                            <th>LEDçŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                æš‚æ— å†å²æ•°æ®
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="tab-content" id="control-tab">
                <h4>è®¾å¤‡æ§åˆ¶å‘½ä»¤</h4>
                <p style="color: #666; margin-bottom: 15px;">å‘è®¾å¤‡å‘é€æ§åˆ¶æŒ‡ä»¤</p>
                
                <div class="control-panel">
                    <div class="control-btn" onclick="sendCommand('GET_TEMP')">è·å–æ¸©åº¦</div>
                    <div class="control-btn" onclick="sendCommand('GET_HUMI')">è·å–æ¹¿åº¦</div>
                    <div class="control-btn" onclick="sendCommand('GET_ALL')">è·å–å…¨éƒ¨</div>
                    <div class="control-btn" onclick="sendCommand('STATUS')">è®¾å¤‡çŠ¶æ€</div>
                    <div class="control-btn" onclick="sendCommand('WIFI_INFO')">WiFiä¿¡æ¯</div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>LEDæ§åˆ¶</h4>
                    <div class="control-panel">
                        <div class="control-btn" onclick="controlLED('ON')">æ‰“å¼€LED</div>
                        <div class="control-btn" onclick="controlLED('OFF')">å…³é—­LED</div>
                        <div class="control-btn" onclick="controlLED('TOGGLE')">åˆ‡æ¢LED</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>è‡ªå®šä¹‰å‘½ä»¤</h4>
                    <div class="command-input">
                        <input type="text" id="custom-command" class="form-control" placeholder="è¾“å…¥è‡ªå®šä¹‰å‘½ä»¤ï¼Œå¦‚: RESTART, GET_TEMP, GET_HUMIç­‰">
                        <button class="btn" onclick="sendCustomCommand()">å‘é€</button>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>ğŸ“¡ å‘½ä»¤è¯´æ˜</h4>
                    <ul style="color: #666; padding-left: 20px; margin-top: 10px;">
                        <li><strong>GET_TEMP</strong>: è·å–å½“å‰æ¸©åº¦</li>
                        <li><strong>GET_HUMI</strong>: è·å–å½“å‰æ¹¿åº¦</li>
                        <li><strong>GET_ALL</strong>: è·å–å…¨éƒ¨ä¼ æ„Ÿå™¨æ•°æ®</li>
                        <li><strong>STATUS</strong>: è·å–è®¾å¤‡çŠ¶æ€</li>
                        <li><strong>WIFI_INFO</strong>: è·å–WiFiä¿¡æ¯</li>
                        <li><strong>RESTART</strong>: é‡å¯è®¾å¤‡</li>
                        <li><strong>LEDæ§åˆ¶</strong>: ON/OFF/TOGGLE</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- æ–°å¢è®¾å¤‡çŠ¶æ€ç›‘æ§æ¡† -->
        <div class="status-panel">
            <div class="card-header">
                <i>ğŸ“Š</i>
                <h3>è®¾å¤‡çŠ¶æ€ç›‘æ§</h3>
                <div class="device-status">
                    <span class="status-indicator" id="status-mqtt-status-indicator"></span>
                    çŠ¶æ€è®¢é˜…: <span id="status-mqtt-status-text">å·²è®¢é˜…</span>
                </div>
            </div>
            
            <div id="status-container" class="status-grid">
                <div class="no-data">
                    <div>ğŸ“¡</div>
                    <h3>æš‚æ— è®¾å¤‡çŠ¶æ€æ•°æ®</h3>
                    <p>ç­‰å¾…è®¾å¤‡å‘å¸ƒçŠ¶æ€ä¿¡æ¯</p>
                </div>
            </div>
        </div>
        
        <div class="config-panel">
            <div class="card-header">
                <i>âš™ï¸</i>
                <h3>MQTTé…ç½®</h3>
            </div>
            
            <div class="form-group">
                <label>MQTTæœåŠ¡å™¨åœ°å€:</label>
                <input type="text" id="mqtt-broker" class="form-control" value="wss://broker.hivemq.com:8884/mqtt" placeholder="wss://broker.hivemq.com:8884/mqtt">
                <small style="color: #666; margin-top: 5px; display: block;">ä½¿ç”¨WebSocketè¿æ¥ (HiveMQå…¬å…±æœåŠ¡å™¨)</small>
            </div>
            
            <div class="form-group">
                <label>æ•°æ®è®¢é˜…ä¸»é¢˜:</label>
                <input type="text" id="mqtt-topic-data" class="form-control" value="ch_dzbg/data/#" placeholder="ch_dzbg/data/#">
                <small style="color: #666; margin-top: 5px; display: block;">ä½¿ç”¨é€šé…ç¬¦ # è®¢é˜…æ‰€æœ‰å­ä¸»é¢˜</small>
            </div>
            
            <div class="form-group">
                <label>æ§åˆ¶å‘å¸ƒä¸»é¢˜:</label>
                <input type="text" id="mqtt-topic-command" class="form-control" value="ch_dzbg/data/cmd" placeholder="ch_dzbg/data/cmd">
                <small style="color: #666; margin-top: 5px; display: block;">å‘é€æ§åˆ¶å‘½ä»¤åˆ°è¯¥ä¸»é¢˜</small>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="connectMQTT()" class="btn" id="connect-btn">è¿æ¥MQTTæœåŠ¡å™¨</button>
                <button onclick="clearData()" class="btn btn-danger">æ¸…é™¤æ•°æ®</button>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin-bottom: 10px;">ğŸ“¡ è¿æ¥çŠ¶æ€</h4>
                <div>MQTTæœåŠ¡å™¨: <span id="current-broker">æœªè¿æ¥</span></div>
                <div>æ•°æ®ä¸»é¢˜: <span id="current-topic-data">æœªè®¾ç½®</span></div>
                <div>æ§åˆ¶ä¸»é¢˜: <span id="current-topic-command">æœªè®¾ç½®</span></div>
                <div>æœ€åæ¶ˆæ¯: <span id="last-message-time">--</span></div>
                <div>æ¥æ”¶æ¶ˆæ¯æ•°: <span id="message-count">0</span></div>
                <div>å·²è¿æ¥è®¾å¤‡: <span id="connected-devices">0</span></div>
            </div>
        </div>
        
        <div class="last-update">
            <p>ç›‘æ§ç³»ç»Ÿ v2.0 | ESP32 AHT20 ç›‘æ§ | æ”¯æŒåŒå‘æ§åˆ¶ | æœ€åæ›´æ–°: <span id="last-update-time">--:--:--</span></p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let mqttClient = null;
        let dataChart = null;
        let devices = new Map();
        let selectedDevice = null;
        let messageCount = 0;
        let commandTopic = "ch_dzbg/data/cmd";  // é»˜è®¤å‘½ä»¤ä¸»é¢˜
        let deviceStatuses = new Map(); // å­˜å‚¨è®¾å¤‡çŠ¶æ€ä¿¡æ¯
        
        // å›¾è¡¨æ•°æ®
        let chartData = {
            labels: [],
            datasets: [{
                label: 'æ¸©åº¦ (Â°C)',
                data: [],
                borderColor: 'rgb(231, 76, 60)',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }, {
                label: 'æ¹¿åº¦ (%)',
                data: [],
                borderColor: 'rgb(52, 152, 219)',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        };
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<div>${message}</div>`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            
            if (dataChart) {
                dataChart.destroy();
            }
            
            dataChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { font: { size: 14 } }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { size: 12 } }
                        },
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { size: 12 } }
                        }
                    }
                }
            });
        }
        
        // è¿æ¥MQTTæœåŠ¡å™¨
        function connectMQTT() {
            const broker = document.getElementById('mqtt-broker').value.trim();
            const topicData = document.getElementById('mqtt-topic-data').value.trim();
            const topicCommand = document.getElementById('mqtt-topic-command').value.trim();
            
            if (!broker || !topicData) {
                showNotification('è¯·å¡«å†™MQTTæœåŠ¡å™¨åœ°å€å’Œè®¢é˜…ä¸»é¢˜', 'error');
                return;
            }
            
            // ä¿å­˜å‘½ä»¤ä¸»é¢˜
            commandTopic = topicCommand;
            
            // å¦‚æœå·²è¿æ¥ï¼Œå…ˆæ–­å¼€
            if (mqttClient && mqttClient.connected) {
                mqttClient.end();
            }
            
            // æ›´æ–°UIçŠ¶æ€
            document.getElementById('current-broker').textContent = broker;
            document.getElementById('current-topic-data').textContent = topicData;
            document.getElementById('current-topic-command').textContent = topicCommand;
            document.getElementById('connect-btn').textContent = 'è¿æ¥ä¸­...';
            document.getElementById('connect-btn').disabled = true;
            
            // MQTTè¿æ¥é€‰é¡¹
            const options = {
                clean: true,
                connectTimeout: 4000,
                clientId: 'web_client_' + Math.random().toString(16).substr(2, 8),
                keepalive: 60
            };
            
            try {
                // è¿æ¥MQTT
                mqttClient = mqtt.connect(broker, options);
                
                mqttClient.on('connect', () => {
                    console.log('MQTTè¿æ¥æˆåŠŸ');
                    showNotification('MQTTè¿æ¥æˆåŠŸ', 'success');
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    document.getElementById('mqtt-status-indicator').className = 'status-indicator status-online';
                    document.getElementById('mqtt-status-text').textContent = 'å·²è¿æ¥';
                    document.getElementById('connect-btn').textContent = 'å·²è¿æ¥';
                    document.getElementById('connect-btn').disabled = true;
                    
                    // è®¢é˜…æ•°æ®ä¸»é¢˜
                    mqttClient.subscribe(topicData, (err) => {
                        if (err) {
                            console.error('è®¢é˜…å¤±è´¥:', err);
                            showNotification('è®¢é˜…å¤±è´¥: ' + err.message, 'error');
                        } else {
                            console.log(`å·²è®¢é˜…ä¸»é¢˜: ${topicData}`);
                            showNotification(`å·²è®¢é˜…ä¸»é¢˜: ${topicData}`, 'success');
                        }
                    });
                    
                    // è®¢é˜…çŠ¶æ€ä¸»é¢˜
                    mqttClient.subscribe("ch_dzbg/data/status", (err) => {
                        if (err) {
                            console.error('è®¢é˜…çŠ¶æ€ä¸»é¢˜å¤±è´¥:', err);
                        } else {
                            console.log('å·²è®¢é˜…çŠ¶æ€ä¸»é¢˜: ch_dzbg/data/status');
                            document.getElementById('status-mqtt-status-indicator').className = 'status-indicator status-online';
                            document.getElementById('status-mqtt-status-text').textContent = 'å·²è®¢é˜…';
                        }
                    });
                });
                
                mqttClient.on('message', (topic, message) => {
                    try {
                        const data = JSON.parse(message.toString());
                        processMessage(topic, data);
                    } catch (error) {
                        console.error('è§£ææ¶ˆæ¯å¤±è´¥:', error, 'åŸå§‹æ¶ˆæ¯:', message.toString());
                    }
                });
                
                mqttClient.on('error', (error) => {
                    console.error('MQTTé”™è¯¯:', error);
                    showNotification('è¿æ¥é”™è¯¯: ' + error.message, 'error');
                    
                    document.getElementById('mqtt-status-indicator').className = 'status-indicator status-offline';
                    document.getElementById('mqtt-status-text').textContent = 'è¿æ¥å¤±è´¥';
                    document.getElementById('connect-btn').textContent = 'è¿æ¥MQTTæœåŠ¡å™¨';
                    document.getElementById('connect-btn').disabled = false;
                });
                
                mqttClient.on('close', () => {
                    console.log('MQTTè¿æ¥æ–­å¼€');
                    showNotification('è¿æ¥å·²æ–­å¼€', 'info');
                    
                    document.getElementById('mqtt-status-indicator').className = 'status-indicator status-offline';
                    document.getElementById('mqtt-status-text').textContent = 'å·²æ–­å¼€';
                    document.getElementById('connect-btn').textContent = 'è¿æ¥MQTTæœåŠ¡å™¨';
                    document.getElementById('connect-btn').disabled = false;
                });
                
            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                showNotification('è¿æ¥å¤±è´¥: ' + error.message, 'error');
                
                document.getElementById('connect-btn').textContent = 'è¿æ¥MQTTæœåŠ¡å™¨';
                document.getElementById('connect-btn').disabled = false;
            }
        }
        
        // å¤„ç†MQTTæ¶ˆæ¯
        function processMessage(topic, data) {
            messageCount++;
            document.getElementById('message-count').textContent = messageCount;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            // æ›´æ–°æœ€åæ¶ˆæ¯æ—¶é—´
            document.getElementById('last-message-time').textContent = timeStr;
            document.getElementById('last-update-time').textContent = timeStr;
            
            // åŒºåˆ†æ•°æ®ä¸»é¢˜å’ŒçŠ¶æ€ä¸»é¢˜
            if (topic.includes('/status')) {
                // å¤„ç†çŠ¶æ€ä¿¡æ¯
                processStatusMessage(data);
            } else {
                // å¤„ç†æ•°æ®ä¿¡æ¯
                processDataMessage(topic, data);
            }
        }
        
        // å¤„ç†çŠ¶æ€æ¶ˆæ¯
        function processStatusMessage(data) {
            // æå–è®¾å¤‡ID
            let deviceId = data.device_id || data.device || data.deviceId || 'æœªçŸ¥è®¾å¤‡';
            
            // æ›´æ–°çŠ¶æ€ä¿¡æ¯
            deviceStatuses.set(deviceId, {
                ...data,
                lastUpdate: new Date().getTime(),
                topic: 'status'
            });
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateStatusDisplay();
        }
        
        // å¤„ç†æ•°æ®æ¶ˆæ¯
        function processDataMessage(topic, data) {
            // æå–è®¾å¤‡ID - å¤„ç†å¤šç§å¯èƒ½çš„å­—æ®µå
            let deviceId = data.device_id || data.device || data.deviceId;
            
            // æ·»åŠ IPåœ°å€åˆ°è®¾å¤‡IDï¼ˆå¦‚æœæœ‰ï¼‰
            if (data.ip) {
                deviceId = `${deviceId} (${data.ip})`;
            }
            
            // å­˜å‚¨è®¾å¤‡æ•°æ®
            if (!devices.has(deviceId)) {
                devices.set(deviceId, {
                    id: deviceId,
                    data: [],
                    lastUpdate: new Date().getTime(),
                    online: true,
                    sensorStatus: data.sensor_connected !== undefined ? data.sensor_connected : true,
                    ledState: data.led_state !== undefined ? data.led_state : false
                });
                
                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªè®¾å¤‡ï¼Œè‡ªåŠ¨é€‰ä¸­
                if (!selectedDevice) {
                    selectedDevice = deviceId;
                }
            }
            
            const device = devices.get(deviceId);
            device.lastUpdate = new Date().getTime();
            device.online = true;
            
            // æ›´æ–°ä¼ æ„Ÿå™¨çŠ¶æ€
            if (data.sensor_connected !== undefined) {
                device.sensorStatus = data.sensor_connected;
            }
            
            // æ›´æ–°LEDçŠ¶æ€
            if (data.led_state !== undefined) {
                device.ledState = data.led_state;
            }
            
            // ä»æ•°æ®ä¸­æå–æ¸©åº¦æ¹¿åº¦
            const temperature = data.temperature;
            const humidity = data.humidity;
            
            // åˆ›å»ºè®°å½•
            const record = {
                time: new Date(),
                timestamp: data.timestamp || new Date().getTime(),
                temperature: temperature,
                humidity: humidity,
                topic: topic,
                sensorStatus: data.sensor_connected,
                ledState: data.led_state,
                ip: data.ip,
                rssi: data.rssi
            };
            
            device.data.push(record);
            
            // ä¿æŒæœ€è¿‘50æ¡è®°å½•
            if (device.data.length > 50) {
                device.data.shift();
            }
            
            // æ›´æ–°æ˜¾ç¤º - åªæ›´æ–°é€‰ä¸­çš„è®¾å¤‡ä¿¡æ¯åˆ°ä¸»æ˜¾ç¤ºåŒºåŸŸ
            if (selectedDevice && selectedDevice === deviceId) {
                updateMainDisplay(deviceId, record);
            }
            
            updateDevicesList();
            updateStatistics();
            updateHistoryTable(deviceId, record);
            
            // å¦‚æœè¿™æ˜¯é€‰ä¸­çš„è®¾å¤‡ï¼Œæ›´æ–°å›¾è¡¨
            if (deviceId === selectedDevice) {
                updateChart(device);
            }
        }
        
        // æ›´æ–°ä¸»æ˜¾ç¤º
        function updateMainDisplay(deviceId, record) {
            if (record.temperature !== undefined) {
                document.getElementById('current-temp').textContent = 
                    record.temperature.toFixed(1) + 'Â°C';
                document.getElementById('temp-device').textContent = 'è®¾å¤‡: ' + deviceId.split('(')[0];
            }
            
            if (record.humidity !== undefined) {
                document.getElementById('current-hum').textContent = 
                    record.humidity.toFixed(1) + '%';
                document.getElementById('hum-device').textContent = 'è®¾å¤‡: ' + deviceId.split('(')[0];
            }
            
            // æ›´æ–°ä¼ æ„Ÿå™¨çŠ¶æ€
            if (record.sensorStatus !== undefined) {
                const statusText = record.sensorStatus ? 'æ­£å¸¸' : 'å¼‚å¸¸';
                const statusColor = record.sensorStatus ? '#2ecc71' : '#e74c3c';
                document.getElementById('sensor-status').textContent = statusText;
                document.getElementById('sensor-status').style.color = statusColor;
            }
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateChart(device) {
            if (!device || device.data.length === 0) return;
            
            // æ¸…ç©ºå›¾è¡¨æ•°æ®
            chartData.labels = [];
            chartData.datasets[0].data = [];
            chartData.datasets[1].data = [];
            
            // æ·»åŠ æœ€è¿‘20ä¸ªæ•°æ®ç‚¹
            const recentData = device.data.slice(-20);
            
            recentData.forEach(record => {
                const timeLabel = record.time.getHours().toString().padStart(2, '0') + ':' + 
                                record.time.getMinutes().toString().padStart(2, '0') + ':' + 
                                record.time.getSeconds().toString().padStart(2, '0');
                
                chartData.labels.push(timeLabel);
                chartData.datasets[0].data.push(record.temperature);
                chartData.datasets[1].data.push(record.humidity);
            });
            
            // åˆå§‹åŒ–æˆ–æ›´æ–°å›¾è¡¨
            if (!dataChart) {
                initChart();
            } else {
                dataChart.update('none');
            }
        }
        
        // æ›´æ–°è®¾å¤‡åˆ—è¡¨
        function updateDevicesList() {
            const container = document.getElementById('devices-container');
            
            if (devices.size === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <div>ğŸ“¡</div>
                        <h3>æš‚æ— è®¾å¤‡æ•°æ®</h3>
                        <p>è¯·ç¡®ä¿MQTTè¿æ¥æ­£å¸¸ï¼Œå¹¶ä¸”æœ‰è®¾å¤‡åœ¨å‘å¸ƒæ•°æ®</p>
                    </div>
                `;
                return;
            }
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // æ·»åŠ è®¾å¤‡å¡ç‰‡
            devices.forEach((device, deviceId) => {
                const latestRecord = device.data[device.data.length - 1];
                const timeDiff = (Date.now() - device.lastUpdate) / 1000;
                const isOnline = timeDiff < 60;
                
                const deviceCard = document.createElement('div');
                deviceCard.className = 'device-card';
                if (deviceId === selectedDevice) {
                    deviceCard.classList.add('selected');
                }
                deviceCard.style.cursor = 'pointer';
                
                deviceCard.onclick = () => {
                    selectedDevice = deviceId;
                    updateDevicesList();
                    
                    // æ›´æ–°ä¸»æ˜¾ç¤ºåŒºåŸŸä¸ºé€‰ä¸­çš„è®¾å¤‡æ•°æ®
                    if (device.data.length > 0) {
                        updateMainDisplay(deviceId, device.data[device.data.length - 1]);
                        updateChart(device);
                    }
                };

                deviceCard.setAttribute('data-device-id', deviceId); // ç¡®ä¿è¿™ä¸ªå±æ€§å­˜åœ¨

                // æ·»åŠ åŒå‡»äº‹ä»¶
                deviceCard.addEventListener('dblclick', function() {
                    const deviceId = this.getAttribute('data-device-id');
                    if (confirm(`ç¡®å®šè¦åˆ é™¤è®¾å¤‡ ${deviceId} å—ï¼Ÿ`)) {
                        // ä»è®¾å¤‡åˆ—è¡¨ä¸­ç§»é™¤
                        devices.delete(deviceId);
                        
                        // é‡æ–°æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
                        updateDevicesList();
                    }
                });
                
                let content = `
                    <div class="device-header">
                        <div class="device-name">${deviceId}</div>
                        <div class="device-status">
                            <span class="status-indicator ${isOnline ? 'status-online' : 'status-offline'}"></span>
                            ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                        </div>
                    </div>
                `;
                
                if (latestRecord) {
                    content += `
                        <div class="device-data">
                            <div>
                                <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">æ¸©åº¦</div>
                                <div class="temp-badge">${latestRecord.temperature !== undefined ? latestRecord.temperature.toFixed(1) + 'Â°C' : 'N/A'}</div>
                            </div>
                            <div>
                                <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">æ¹¿åº¦</div>
                                <div class="hum-badge">${latestRecord.humidity !== undefined ? latestRecord.humidity.toFixed(1) + '%' : 'N/A'}</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.8em; color: #666; display: flex; justify-content: space-between;">
                            <div>ä¼ æ„Ÿå™¨: <span style="color: ${device.sensorStatus ? '#2ecc71' : '#e74c3c'};">${device.sensorStatus ? 'æ­£å¸¸' : 'å¼‚å¸¸'}</span></div>
                            <div>LED: <span style="color: ${device.ledState ? '#2ecc71' : '#e74c3c'};">${device.ledState ? 'å¼€' : 'å…³'}</span></div>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.8em; color: #888;">
                            æœ€åæ›´æ–°: ${new Date(device.lastUpdate).toLocaleTimeString()}
                        </div>
                    `;
                } else {
                    content += `
                        <div style="color: #999; text-align: center; padding: 10px 0;">
                            æš‚æ— æ•°æ®
                        </div>
                    `;
                }
                
                deviceCard.innerHTML = content;
                container.appendChild(deviceCard);
            });
        }
        
        // æ›´æ–°è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay() {
            const container = document.getElementById('status-container');
            
            if (deviceStatuses.size === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <div>ğŸ“¡</div>
                        <h3>æš‚æ— è®¾å¤‡çŠ¶æ€æ•°æ®</h3>
                        <p>ç­‰å¾…è®¾å¤‡å‘å¸ƒçŠ¶æ€ä¿¡æ¯</p>
                    </div>
                `;
                return;
            }
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';
            
            // æ·»åŠ çŠ¶æ€å¡ç‰‡
            // éå†æ‰€æœ‰è®¾å¤‡çŠ¶æ€ä¿¡æ¯
            deviceStatuses.forEach((status, deviceId) => {
                // è®¡ç®—è®¾å¤‡æœ€åæ›´æ–°æ—¶é—´ä¸å½“å‰æ—¶é—´çš„å·®å€¼ï¼ˆç§’ï¼‰
                const timeDiff = (Date.now() - status.lastUpdate) / 1000;
                // å¦‚æœ60ç§’å†…æœ‰æ›´æ–°åˆ™è®¤ä¸ºåœ¨çº¿
                const isOnline = timeDiff < 60;
                
                // åˆ›å»ºä¸€ä¸ªçŠ¶æ€å¡ç‰‡DOMå…ƒç´ 
                const statusCard = document.createElement('div');
                statusCard.className = 'status-card';
                // æ ¹æ®åœ¨çº¿çŠ¶æ€è®¾ç½®è¾¹æ¡†é¢œè‰²
                statusCard.style.borderLeftColor = isOnline ? '#3498db' : '#ddd';

                // æ·»åŠ å…³é”®å±æ€§ï¼šå­˜å‚¨è®¾å¤‡ID
                statusCard.setAttribute('data-device-id', deviceId);

                // æ·»åŠ åŒå‡»äº‹ä»¶ç›‘å¬å™¨
                statusCard.addEventListener('dblclick', function() {
                    const deviceId = this.getAttribute('data-device-id');
                    if (confirm(`ç¡®å®šè¦åˆ é™¤è®¾å¤‡ ${deviceId} å—ï¼Ÿ`)) {
                        // ä»çŠ¶æ€ç›‘æ§ä¸­ç§»é™¤
                        deviceStatuses.delete(deviceId);
                        
                        // åŒæ—¶ä»è®¾å¤‡åˆ—è¡¨ä¸­ç§»é™¤ï¼ˆå¦‚æœè®¾å¤‡åˆ—è¡¨å­˜åœ¨ï¼‰
                        // åœ¨Mapä¸­æŸ¥æ‰¾è®¾å¤‡
                        const device = devices.get(deviceId);
                        if (device) {
                            devices.delete(deviceId);
                        }
                        //const deviceIndex = devices.findIndex(d => d.id === deviceId);
                        //if (deviceIndex !== -1) {
                        //    devices.splice(deviceIndex, 1);
                        //}
            
                    // é‡æ–°æ¸²æŸ“çŠ¶æ€ç›‘æ§å’Œè®¾å¤‡åˆ—è¡¨
                    updateStatusDisplay();
                    renderDeviceList();
                }
            });
                
                // æ„å»ºå¡ç‰‡çš„HTMLå†…å®¹
                let content = `
                    <div class="status-header">
                        <div class="status-name">${deviceId}</div>
                    </div>

                    <div class="status-details">
                `;
                
                // æ·»åŠ å…¶ä»–çŠ¶æ€ä¿¡æ¯
                // éå†çŠ¶æ€å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œæ’é™¤ä¸€äº›å†…éƒ¨å­—æ®µ
                for (const key in status) {
                    if (key !== 'device_id' && key !== 'device' && key !== 'deviceId' && 
                        key !== 'lastUpdate' && key !== 'topic' && key !== 'status' && 
                        key !== 'state' && key !== 'mode') {
                        // æ·»åŠ çŠ¶æ€ä¿¡æ¯åˆ°å†…å®¹ä¸­
                        content += `<div>${key}: ${status[key]}</div>`;
                    }
                }
                
                // æ·»åŠ æœ€åæ›´æ–°æ—¶é—´å¹¶é—­åˆæ ‡ç­¾
                content += `
                        <div>æœ€åæ›´æ–°: ${new Date(status.lastUpdate).toLocaleTimeString()}</div>
                    </div>
                `;

                // å°†æ„å»ºå¥½çš„å†…å®¹è®¾ç½®åˆ°å¡ç‰‡å…ƒç´ ä¸­
                statusCard.innerHTML = content;
                // å°†å¡ç‰‡æ·»åŠ åˆ°å®¹å™¨ä¸­
                container.appendChild(statusCard);
            });
        }


        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStatistics() {
            let totalTemp = 0;
            let totalHum = 0;
            let tempCount = 0;
            let humCount = 0;
            let maxTemp = -Infinity;
            let minTemp = Infinity;
            let onlineCount = 0;
            
            const now = Date.now();
            
            devices.forEach(device => {
                if (now - device.lastUpdate < 60000) {
                    onlineCount++;
                }
                
                if (device.data.length > 0) {
                    const latest = device.data[device.data.length - 1];
                    
                    if (latest.temperature !== undefined) {
                        totalTemp += latest.temperature;
                        tempCount++;
                        maxTemp = Math.max(maxTemp, latest.temperature);
                        minTemp = Math.min(minTemp, latest.temperature);
                    }
                    
                    if (latest.humidity !== undefined) {
                        totalHum += latest.humidity;
                        humCount++;
                    }
                }
            });
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('total-devices').textContent = devices.size;
            document.getElementById('online-devices').textContent = onlineCount;
            document.getElementById('connected-devices').textContent = onlineCount;
            
            if (tempCount > 0) {
                const avgTemp = totalTemp / tempCount;
                document.getElementById('avg-temperature').textContent = avgTemp.toFixed(1) + 'Â°C';
                document.getElementById('avg-temp-display').textContent = avgTemp.toFixed(1) + 'Â°C';
                document.getElementById('max-temp').textContent = maxTemp.toFixed(1) + 'Â°C';
                document.getElementById('min-temp').textContent = minTemp.toFixed(1) + 'Â°C';
            }
            
            if (humCount > 0) {
                const avgHum = totalHum / humCount;
                document.getElementById('avg-humidity').textContent = avgHum.toFixed(1) + '%';
                document.getElementById('avg-hum-display').textContent = avgHum.toFixed(1) + '%';
            }
        }
        
        // æ›´æ–°å†å²æ•°æ®è¡¨
        function updateHistoryTable(deviceId, record) {
            const tbody = document.getElementById('history-table-body');
            
            // ç§»é™¤"æš‚æ— æ•°æ®"è¡Œ
            if (tbody.children.length === 1 && tbody.children[0].children.length === 1) {
                tbody.innerHTML = '';
            }
            
            const timeStr = record.time.toLocaleTimeString();
            const tempStr = record.temperature !== undefined ? record.temperature.toFixed(1) + 'Â°C' : 'N/A';
            const humStr = record.humidity !== undefined ? record.humidity.toFixed(1) + '%' : 'N/A';
            const sensorStr = record.sensorStatus ? 'æ­£å¸¸' : 'å¼‚å¸¸';
            const sensorColor = record.sensorStatus ? '#2ecc71' : '#e74c3c';
            const ledStr = record.ledState ? 'å¼€' : 'å…³';
            const ledColor = record.ledState ? '#2ecc71' : '#e74c3c';
            
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${timeStr}</td>
                <td>${deviceId.split('(')[0]}</td>
                <td>${tempStr}</td>
                <td>${humStr}</td>
                <td style="color: ${sensorColor};">${sensorStr}</td>
                <td style="color: ${ledColor};">${ledStr}</td>
            `;
            
            tbody.insertBefore(newRow, tbody.firstChild);
            
            // é™åˆ¶è¡Œæ•°
            if (tbody.children.length > 50) {
                tbody.removeChild(tbody.lastChild);
            }
        }
        
        // å‘é€å‘½ä»¤
        function sendCommand(command) {
            if (!mqttClient || !mqttClient.connected) {
                showNotification('è¯·å…ˆè¿æ¥MQTTæœåŠ¡å™¨', 'error');
                return;
            }
            
            mqttClient.publish(commandTopic, command, { qos: 0, retain: false }, (error) => {
                if (error) {
                    showNotification(`å‘é€å‘½ä»¤å¤±è´¥: ${command}`, 'error');
                    console.error('å‘é€å‘½ä»¤å¤±è´¥:', error);
                } else {
                    showNotification(`å·²å‘é€å‘½ä»¤: ${command}`, 'success');
                    console.log(`å‘½ä»¤å·²å‘é€: ${command}`);
                }
            });
        }
        
        // æ§åˆ¶LED
        function controlLED(action) {
            if (!mqttClient || !mqttClient.connected) {
                showNotification('è¯·å…ˆè¿æ¥MQTTæœåŠ¡å™¨', 'error');
                return;
            }
            
            mqttClient.publish("ch_dzbg/data/led", action, { qos: 0, retain: false }, (error) => {
                if (error) {
                    showNotification(`LEDæ§åˆ¶å¤±è´¥: ${action}`, 'error');
                    console.error('LEDæ§åˆ¶å¤±è´¥:', error);
                } else {
                    showNotification(`å·²å‘é€LEDå‘½ä»¤: ${action}`, 'success');
                    console.log(`LEDå‘½ä»¤å·²å‘é€: ${action}`);
                }
            });
        }
        
        // å‘é€è‡ªå®šä¹‰å‘½ä»¤
        function sendCustomCommand() {
            const command = document.getElementById('custom-command').value.trim();
            if (!command) {
                showNotification('è¯·è¾“å…¥å‘½ä»¤', 'error');
                return;
            }
            
            sendCommand(command);
            document.getElementById('custom-command').value = '';
        }
        
        // æ¸…é™¤æ•°æ®
        function clearData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                devices.clear();
                deviceStatuses.clear();
                selectedDevice = null;
                messageCount = 0;
                
                // é‡ç½®æ˜¾ç¤º
                document.getElementById('current-temp').textContent = '--Â°C';
                document.getElementById('current-hum').textContent = '--%';
                document.getElementById('temp-device').textContent = 'è®¾å¤‡: --';
                document.getElementById('hum-device').textContent = 'è®¾å¤‡: --';
                document.getElementById('sensor-status').textContent = '--';
                document.getElementById('max-temp').textContent = '--Â°C';
                document.getElementById('min-temp').textContent = '--Â°C';
                document.getElementById('avg-temp-display').textContent = '--Â°C';
                document.getElementById('avg-hum-display').textContent = '--%';
                document.getElementById('total-devices').textContent = '0';
                document.getElementById('online-devices').textContent = '0';
                document.getElementById('avg-temperature').textContent = '--Â°C';
                document.getElementById('avg-humidity').textContent = '--%';
                document.getElementById('message-count').textContent = '0';
                document.getElementById('connected-devices').textContent = '0';
                
                // æ¸…ç©ºè¡¨æ ¼
                const tbody = document.getElementById('history-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                            æš‚æ— å†å²æ•°æ®
                        </td>
                    </tr>
                `;
                
                // æ¸…ç©ºè®¾å¤‡åˆ—è¡¨
                const devicesContainer = document.getElementById('devices-container');
                devicesContainer.innerHTML = `
                    <div class="no-data">
                        <div>ğŸ“¡</div>
                        <h3>æš‚æ— è®¾å¤‡æ•°æ®</h3>
                        <p>è¯·ç¡®ä¿MQTTè¿æ¥æ­£å¸¸ï¼Œå¹¶ä¸”æœ‰è®¾å¤‡åœ¨å‘å¸ƒæ•°æ®</p>
                    </div>
                `;
                
                // æ¸…ç©ºçŠ¶æ€åˆ—è¡¨
                const statusContainer = document.getElementById('status-container');
                statusContainer.innerHTML = `
                    <div class="no-data">
                        <div>ğŸ“¡</div>
                        <h3>æš‚æ— è®¾å¤‡çŠ¶æ€æ•°æ®</h3>
                        <p>ç­‰å¾…è®¾å¤‡å‘å¸ƒçŠ¶æ€ä¿¡æ¯</p>
                    </div>
                `;
                
                // æ¸…ç©ºå›¾è¡¨
                if (dataChart) {
                    chartData.labels = [];
                    chartData.datasets[0].data = [];
                    chartData.datasets[1].data = [];
                    dataChart.update();
                }
                
                showNotification('æ•°æ®å·²æ¸…é™¤', 'info');
            }
        }
        
        // åˆå§‹åŒ–æ ‡ç­¾é¡µ
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tabId + '-tab').classList.add('active');
                    
                    if (tabId === 'chart' && selectedDevice && devices.has(selectedDevice)) {
                        updateChart(devices.get(selectedDevice));
                    }
                });
            });
        }
        
        // å®šæœŸæ£€æŸ¥è®¾å¤‡çŠ¶æ€
        function checkDeviceStatus() {
            const now = Date.now();
            
            devices.forEach(device => {
                device.online = (now - device.lastUpdate) < 60000;
            });
            
            deviceStatuses.forEach(status => {
                status.online = (now - status.lastUpdate) < 60000;
            });
            
            updateDevicesList();
            updateStatusDisplay();
            updateStatistics();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            // åˆå§‹åŒ–æ ‡ç­¾é¡µ
            initTabs();
            
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
            
            // è‡ªåŠ¨è¿æ¥
            setTimeout(() => {
                connectMQTT();
            }, 1000);
            
            // å®šæœŸæ£€æŸ¥è®¾å¤‡çŠ¶æ€
            setInterval(checkDeviceStatus, 30000);
            
            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            setTimeout(() => {
                showNotification('ç³»ç»Ÿå·²å¯åŠ¨ï¼Œæ­£åœ¨è¿æ¥MQTTæœåŠ¡å™¨...', 'info');
            }, 500);
        };
        
        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                const customCmd = document.getElementById('custom-command');
                if (document.activeElement === customCmd) {
                    sendCustomCommand();
                }
            }
        });
    </script>
</body>
</html>

